{% extends 'base.html' %}

{% block title %}Annual Summary - Budget Manager{% endblock %}

{% block page_title %}Annual Report - {{ year }}{% endblock %}

{% block content %}
<!-- Filter Form -->
<div class="d-flex justify-content-end mb-3">
    <form method="get" class="d-flex align-items-center gap-2">
        <input type="number" name="year" class="form-control form-control-sm" value="{{ year }}"
               min="2020" max="2025" style="width: 90px;">
        <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-filter"></i> Filter
        </button>
    </form>
</div>

<!-- Financial Summary -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center py-2">
                <h6 class="text-muted mb-1" style="font-size: 0.75rem;">ðŸ’° Total Net Worth</h6>
                <h3 class="mb-0" style="font-size: 1.25rem; font-weight: 700;" class="{% if net_worth >= 0 %}text-success{% else %}text-danger{% endif %}">${{ net_worth|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center py-2">
                <h6 class="text-muted mb-1" style="font-size: 0.75rem;">ðŸ’µ Total Savings</h6>
                <h3 class="mb-0" style="font-size: 1.25rem; font-weight: 700;" class="{% if annual_savings >= 0 %}text-success{% else %}text-danger{% endif %}">${{ annual_savings|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center py-2">
                <h6 class="text-muted mb-1" style="font-size: 0.75rem;">ðŸ“ˆ Total Investments</h6>
                <h3 class="mb-0 text-primary" style="font-size: 1.25rem; font-weight: 700;">${{ total_investments|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center py-2">
                <h6 class="text-muted mb-1" style="font-size: 0.75rem;">ðŸ’¸ Total Expenses</h6>
                <h3 class="mb-0 text-danger" style="font-size: 1.25rem; font-weight: 700;">${{ total_expense|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Trend Chart -->
<div class="card mb-3">
    <div class="card-header bg-white py-2">
        <h5 class="mb-0" style="font-size: 0.875rem;"><i class="bi bi-graph-up"></i> Monthly Trend</h5>
    </div>
    <div class="card-body py-2">
        <canvas id="monthlyTrendChart" height="80"></canvas>
    </div>
</div>

<div class="row mb-3">
    <!-- Income by Category -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-success text-white py-2">
                <h5 class="mb-0" style="font-size: 0.875rem;"><i class="bi bi-arrow-down-circle"></i> Income by Category</h5>
            </div>
            <div class="card-body py-2">
                {% if income_by_category %}
                <div class="row">
                    <div class="col-7">
                        <div style="height: 220px; position: relative;">
                            <canvas id="incomeChart"></canvas>
                        </div>
                    </div>
                    <div class="col-5">
                        <div style="max-height: 220px; overflow-y: auto;">
                            {% for item in income_by_category %}
                            <div class="d-flex justify-content-between mb-1" style="font-size: 0.8125rem;">
                                <span>{{ item.category__name|default:"Uncategorized" }}</span>
                                <strong class="text-success">${{ item.total|floatformat:2 }}</strong>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No income data for this year</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Expenses by Category -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-danger text-white py-2">
                <h5 class="mb-0" style="font-size: 0.875rem;"><i class="bi bi-arrow-up-circle"></i> Expenses by Category</h5>
            </div>
            <div class="card-body py-2">
                {% if expense_by_category %}
                <div class="row">
                    <div class="col-7">
                        <div style="height: 220px; position: relative;">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                    <div class="col-5">
                        <div style="max-height: 220px; overflow-y: auto;">
                            {% for item in expense_by_category %}
                            <div class="d-flex justify-content-between mb-1" style="font-size: 0.8125rem;">
                                <span>{{ item.category__name|default:"Uncategorized" }}</span>
                                <strong class="text-danger">${{ item.total|floatformat:2 }}</strong>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No expense data for this year</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Monthly Breakdown Table -->
<div class="card mb-3">
    <div class="card-header bg-white py-2">
        <h5 class="mb-0" style="font-size: 0.875rem;"><i class="bi bi-calendar-month"></i> Monthly Breakdown</h5>
    </div>
    <div class="card-body py-2">
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr style="font-size: 0.8125rem;">
                        <th>Month</th>
                        <th class="text-end">Income</th>
                        <th class="text-end">Expenses</th>
                        <th class="text-end">Net Savings</th>
                        <th class="text-end">Investments</th>
                    </tr>
                </thead>
                <tbody style="font-size: 0.8125rem;">
                    {% for data in monthly_data %}
                    <tr>
                        <td><strong>{{ data.month }}</strong></td>
                        <td class="text-end text-success">${{ data.income|floatformat:2 }}</td>
                        <td class="text-end text-danger">${{ data.expense|floatformat:2 }}</td>
                        <td class="text-end {% if data.savings >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ data.savings|floatformat:2 }}
                        </td>
                        <td class="text-end text-primary"><strong>${{ data.investment|floatformat:2 }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot style="font-size: 0.8125rem;">
                    <tr class="fw-bold">
                        <td>Total</td>
                        <td class="text-end text-success">${{ total_income|floatformat:2 }}</td>
                        <td class="text-end text-danger">${{ total_expense|floatformat:2 }}</td>
                        <td class="text-end {% if annual_savings >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ annual_savings|floatformat:2 }}
                        </td>
                        <td class="text-end text-primary">${{ total_investments|floatformat:2 }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Monthly Trend Chart
const monthlyTrendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
new Chart(monthlyTrendCtx, {
    type: 'line',
    data: {
        labels: [{% for data in monthly_data %}'{{ data.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Income',
            data: [{% for data in monthly_data %}{{ data.income }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#86efac',
            backgroundColor: 'rgba(134, 239, 172, 0.2)',
            fill: true
        }, {
            label: 'Expenses',
            data: [{% for data in monthly_data %}{{ data.expense }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#fca5a5',
            backgroundColor: 'rgba(252, 165, 165, 0.2)',
            fill: true
        }, {
            label: 'Savings',
            data: [{% for data in monthly_data %}{{ data.savings }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#93c5fd',
            backgroundColor: 'rgba(147, 197, 253, 0.2)',
            fill: true
        }, {
            label: 'Investments',
            data: [{% for data in monthly_data %}{{ data.investment }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#c084fc',
            backgroundColor: 'rgba(192, 132, 252, 0.2)',
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {
            intersect: false,
            mode: 'index'
        }
    }
});

// Generate distinct colors for charts
function generateColors(count, baseHue, saturation = 70, lightness = 70) {
    const colors = [];
    const hueStep = 360 / count;
    for (let i = 0; i < count; i++) {
        const hue = (baseHue + (i * hueStep)) % 360;
        colors.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
    }
    return colors;
}

// Income Chart
{% if income_by_category %}
const incomeCtx = document.getElementById('incomeChart').getContext('2d');
const incomeCount = {{ income_by_category|length }};
new Chart(incomeCtx, {
    type: 'pie',
    data: {
        labels: [{% for item in income_by_category %}'{{ item.category__name|default:"Uncategorized" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for item in income_by_category %}{{ item.total }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: generateColors(incomeCount, 140, 60, 75)
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += '$' + context.parsed.toFixed(2);
                        return label;
                    }
                }
            }
        }
    }
});
{% endif %}

// Expense Chart
{% if expense_by_category %}
const expenseCtx = document.getElementById('expenseChart').getContext('2d');
const expenseCount = {{ expense_by_category|length }};
new Chart(expenseCtx, {
    type: 'pie',
    data: {
        labels: [{% for item in expense_by_category %}'{{ item.category__name|default:"Uncategorized" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for item in expense_by_category %}{{ item.total }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: generateColors(expenseCount, 0, 60, 75)
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += '$' + context.parsed.toFixed(2);
                        return label;
                    }
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}

