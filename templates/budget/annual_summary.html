{% extends 'base.html' %}

{% block title %}Annual Summary - Budget Manager{% endblock %}

{% block page_title %}Annual Report - {{ year }}{% endblock %}

{% block content %}
<!-- Filter Form -->
<div class="d-flex justify-content-end mb-3">
    <form method="get" class="d-flex align-items-center gap-2" id="filterForm">
        <input type="number" name="year" class="form-control form-control-sm" value="{{ year }}"
               min="2020" max="2025" style="width: 90px;">
        
        <!-- Tag Filter Dropdown -->
        <div class="dropdown" style="min-width: 200px;">
            <button class="btn btn-sm btn-light dropdown-toggle w-100 d-flex justify-content-between align-items-center" type="button" id="tagDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="height: 31px; padding: 4px 8px; border: 1px solid #dee2e6;">
                <span id="tagDisplay" style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {% if selected_tags %}
                        {% for tag in all_tags %}
                            {% if tag.id in selected_tags %}
                                <span class="badge tag-badge-selected">{{ tag.name }}</span>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="text-muted" style="font-size: 0.875rem;">Select Tags...</span>
                    {% endif %}
                </span>
            </button>
            <ul class="dropdown-menu py-1" aria-labelledby="tagDropdown" style="max-height: 300px; overflow-y: auto; width: auto; min-width: 180px; max-width: 280px;" onclick="event.stopPropagation();">
                {% if all_tags %}
                    {% for tag in all_tags %}
                    <li class="px-2" style="margin: 0;">
                        <div class="form-check m-0 d-flex align-items-center tag-item {% if tag.id in selected_tags %}selected{% endif %}" style="padding-left: 0;">
                            <input class="form-check-input tag-checkbox" type="checkbox" name="tag" value="{{ tag.id }}" id="tag{{ tag.id }}" {% if tag.id in selected_tags %}checked{% endif %} style="margin-top: 0; width: 14px; height: 14px;">
                            <label class="form-check-label ms-2" for="tag{{ tag.id }}" style="cursor: pointer; font-size: 0.8rem; user-select: none; white-space: nowrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
                                {{ tag.name }}
                            </label>
                        </div>
                    </li>
                    {% endfor %}
                    <li><hr class="dropdown-divider my-1"></li>
                    <li class="px-2 py-1">
                        <button type="button" class="btn btn-sm btn-link text-decoration-none p-0 m-0" onclick="clearAllTags()" style="font-size: 0.8rem;">Clear All</button>
                    </li>
                {% else %}
                    <li class="px-2 py-1 text-muted small">No tags available</li>
                {% endif %}
            </ul>
        </div>
        
        <style>
            .tag-badge-selected {
                background-color: #0d6efd;
                color: white;
                font-size: 0.7rem;
                padding: 2px 6px;
                border-radius: 4px;
                margin-right: 3px;
                font-weight: 500;
            }
            .dropdown-toggle::after {
                margin-left: 0 !important;
            }
            .tag-item {
                transition: background-color 0.15s ease;
                border-radius: 4px;
                padding: 3px 8px;
                margin: 1px 0;
            }
            .tag-item:hover {
                background-color: #f8f9fa;
            }
            .tag-item.selected {
                background-color: #e7f3ff;
            }
            .tag-item.selected label {
                color: #0d6efd;
                font-weight: 500;
            }
        </style>
        
        <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-filter"></i> Filter
        </button>
    </form>
</div>

<script>
function updateTagDisplay() {
    const checkboxes = document.querySelectorAll('.tag-checkbox:checked');
    const display = document.getElementById('tagDisplay');
    
    if (checkboxes.length === 0) {
        display.innerHTML = '<span class="text-muted" style="font-size: 0.875rem;">Select Tags...</span>';
    } else {
        const badges = Array.from(checkboxes).map(cb => {
            const label = document.querySelector(`label[for="${cb.id}"]`).textContent.trim();
            return `<span class="badge tag-badge-selected">${label}</span>`;
        });
        display.innerHTML = badges.join('');
    }
    // Maintain the flex and overflow styles
    display.style.flex = '1';
    display.style.overflow = 'hidden';
    display.style.textOverflow = 'ellipsis';
    display.style.whiteSpace = 'nowrap';
}

function clearAllTags() {
    document.querySelectorAll('.tag-checkbox').forEach(cb => {
        cb.checked = false;
        cb.closest('.tag-item').classList.remove('selected');
    });
    updateTagDisplay();
}

// Update display when checkboxes change
document.querySelectorAll('.tag-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        // Toggle selected class on the parent tag-item
        const tagItem = this.closest('.tag-item');
        if (this.checked) {
            tagItem.classList.add('selected');
        } else {
            tagItem.classList.remove('selected');
        }
        updateTagDisplay();
    });
});
</script>

<!-- Financial Summary -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center py-2">
                <h6 class="text-muted mb-1" style="font-size: 0.75rem;">ðŸ’° Total Net Worth</h6>
                <h3 class="mb-0" style="font-size: 1.25rem; font-weight: 700;" class="{% if net_worth >= 0 %}text-success{% else %}text-danger{% endif %}">${{ net_worth|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center py-2">
                <h6 class="text-muted mb-1" style="font-size: 0.75rem;">ðŸ’µ Total Savings</h6>
                <h3 class="mb-0" style="font-size: 1.25rem; font-weight: 700;" class="{% if annual_savings >= 0 %}text-success{% else %}text-danger{% endif %}">${{ annual_savings|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center py-2">
                <h6 class="text-muted mb-1" style="font-size: 0.75rem;">ðŸ“ˆ Total Investments</h6>
                <h3 class="mb-0 text-primary" style="font-size: 1.25rem; font-weight: 700;">${{ total_investments|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center py-2">
                <h6 class="text-muted mb-1" style="font-size: 0.75rem;">ðŸ’¸ Total Expenses</h6>
                <h3 class="mb-0 text-danger" style="font-size: 1.25rem; font-weight: 700;">${{ total_expense|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Trend Chart -->
<div class="card mb-3">
    <div class="card-header bg-white py-2">
        <h5 class="mb-0" style="font-size: 0.875rem;"><i class="bi bi-graph-up"></i> Monthly Trend</h5>
    </div>
    <div class="card-body py-2">
        <canvas id="monthlyTrendChart" height="80"></canvas>
    </div>
</div>

<div class="row mb-3">
    <!-- Income by Category -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-success text-white py-2">
                <h5 class="mb-0" style="font-size: 0.875rem;"><i class="bi bi-arrow-down-circle"></i> Income by Category</h5>
            </div>
            <div class="card-body py-2">
                {% if income_by_category %}
                <div style="height: 300px; position: relative;">
                    <canvas id="incomeChart"></canvas>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No income data for this year</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Expenses by Category -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-danger text-white py-2">
                <h5 class="mb-0" style="font-size: 0.875rem;"><i class="bi bi-arrow-up-circle"></i> Expenses by Category</h5>
            </div>
            <div class="card-body py-2">
                {% if expense_by_category %}
                <div style="height: 300px; position: relative;">
                    <canvas id="expenseChart"></canvas>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No expense data for this year</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Monthly Breakdown Table -->
<div class="card mb-3">
    <div class="card-header bg-white py-2">
        <h5 class="mb-0" style="font-size: 0.875rem;"><i class="bi bi-calendar-month"></i> Monthly Breakdown</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover modern-breakdown-table mb-0">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th class="text-end">Income</th>
                        <th class="text-end">Expenses</th>
                        <th class="text-end">Net Savings</th>
                        <th class="text-end">Investments</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in monthly_data %}
                    <tr>
                        <td class="month-cell">
                            <strong>{{ data.month }}</strong>
                        </td>
                        <td class="text-end income-cell">
                            <span class="amount-badge income-badge">${{ data.income|floatformat:2 }}</span>
                        </td>
                        <td class="text-end expense-cell">
                            <span class="amount-badge expense-badge">${{ data.expense|floatformat:2 }}</span>
                        </td>
                        <td class="text-end savings-cell">
                            <span class="amount-badge {% if data.savings >= 0 %}savings-positive-badge{% else %}savings-negative-badge{% endif %}">
                                ${{ data.savings|floatformat:2 }}
                            </span>
                        </td>
                        <td class="text-end investment-cell">
                            <span class="amount-badge investment-badge">${{ data.investment|floatformat:2 }}</span>
                        </td>
                        <td class="text-center status-cell">
                            {% if data.savings >= 0 %}
                                <i class="bi bi-check-circle-fill text-success" title="Positive savings"></i>
                            {% else %}
                                <i class="bi bi-dash-circle-fill text-danger" title="Deficit"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td><strong>TOTAL</strong></td>
                        <td class="text-end">
                            <strong class="text-success">${{ total_income|floatformat:2 }}</strong>
                        </td>
                        <td class="text-end">
                            <strong class="text-danger">${{ total_expense|floatformat:2 }}</strong>
                        </td>
                        <td class="text-end">
                            <strong class="{% if annual_savings >= 0 %}text-success{% else %}text-danger{% endif %}">
                                ${{ annual_savings|floatformat:2 }}
                            </strong>
                        </td>
                        <td class="text-end">
                            <strong class="text-primary">${{ total_investments|floatformat:2 }}</strong>
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<style>
.modern-breakdown-table {
    font-size: 0.875rem;
}
.modern-breakdown-table thead {
    background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #dee2e6;
}
.modern-breakdown-table thead th {
    font-weight: 600;
    font-size: 0.8125rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #495057;
    padding: 12px 16px;
    border: none;
}
.modern-breakdown-table tbody tr {
    transition: all 0.2s ease;
    border-bottom: 1px solid #f0f0f0;
}
.modern-breakdown-table tbody tr:hover {
    background-color: #f8f9fa;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.modern-breakdown-table tbody td {
    padding: 14px 16px;
    vertical-align: middle;
}
.month-cell strong {
    color: #212529;
    font-size: 0.9rem;
}
.amount-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.85rem;
}
.income-badge {
    background-color: #d1f4e0;
    color: #198754;
}
.expense-badge {
    background-color: #ffe0e0;
    color: #dc3545;
}
.savings-positive-badge {
    background-color: #d1f4e0;
    color: #198754;
}
.savings-negative-badge {
    background-color: #ffe0e0;
    color: #dc3545;
}
.investment-badge {
    background-color: #e0ebff;
    color: #0d6efd;
}
.status-cell i {
    font-size: 1.1rem;
}
.modern-breakdown-table tfoot {
    border-top: 2px solid #dee2e6;
    background-color: #f8f9fa;
}
.modern-breakdown-table tfoot .total-row td {
    padding: 14px 16px;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Monthly Trend Chart
const monthlyTrendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
new Chart(monthlyTrendCtx, {
    type: 'line',
    data: {
        labels: [{% for data in monthly_data %}'{{ data.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Income',
            data: [{% for data in monthly_data %}{{ data.income }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#86efac',
            backgroundColor: 'rgba(134, 239, 172, 0.2)',
            fill: true
        }, {
            label: 'Expenses',
            data: [{% for data in monthly_data %}{{ data.expense }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#fca5a5',
            backgroundColor: 'rgba(252, 165, 165, 0.2)',
            fill: true
        }, {
            label: 'Savings',
            data: [{% for data in monthly_data %}{{ data.savings }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#93c5fd',
            backgroundColor: 'rgba(147, 197, 253, 0.2)',
            fill: true
        }, {
            label: 'Investments',
            data: [{% for data in monthly_data %}{{ data.investment }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#c084fc',
            backgroundColor: 'rgba(192, 132, 252, 0.2)',
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {
            intersect: false,
            mode: 'index'
        }
    }
});

// Generate distinct colors for charts
function generateColors(count, baseHue, saturation = 70, lightness = 70) {
    const colors = [];
    const hueStep = 360 / count;
    for (let i = 0; i < count; i++) {
        const hue = (baseHue + (i * hueStep)) % 360;
        colors.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
    }
    return colors;
}

// Income Chart
{% if income_by_category %}
const incomeCtx = document.getElementById('incomeChart').getContext('2d');
const incomeCount = {{ income_by_category|length }};
new Chart(incomeCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for item in income_by_category %}'{{ item.category__name|default:"Uncategorized" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for item in income_by_category %}{{ item.total }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: generateColors(incomeCount, 140, 60, 75)
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    padding: 15,
                    font: {
                        size: 11
                    },
                    generateLabels: function(chart) {
                        const data = chart.data;
                        if (data.labels.length && data.datasets.length) {
                            return data.labels.map((label, i) => {
                                const value = data.datasets[0].data[i];
                                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return {
                                    text: `${label}: $${value.toFixed(2)} (${percentage}%)`,
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                };
                            });
                        }
                        return [];
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += '$' + context.parsed.toFixed(2);
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                        label += ` (${percentage}%)`;
                        return label;
                    }
                }
            }
        }
    }
});
{% endif %}

// Expense Chart
{% if expense_by_category %}
const expenseCtx = document.getElementById('expenseChart').getContext('2d');
const expenseCount = {{ expense_by_category|length }};
new Chart(expenseCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for item in expense_by_category %}'{{ item.category__name|default:"Uncategorized" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for item in expense_by_category %}{{ item.total }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: generateColors(expenseCount, 0, 60, 75)
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    padding: 15,
                    font: {
                        size: 11
                    },
                    generateLabels: function(chart) {
                        const data = chart.data;
                        if (data.labels.length && data.datasets.length) {
                            return data.labels.map((label, i) => {
                                const value = data.datasets[0].data[i];
                                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return {
                                    text: `${label}: $${value.toFixed(2)} (${percentage}%)`,
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                };
                            });
                        }
                        return [];
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += '$' + context.parsed.toFixed(2);
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                        label += ` (${percentage}%)`;
                        return label;
                    }
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}

