{% extends 'base.html' %}

{% block title %}Expense List - Budget Manager{% endblock %}

{% block page_title %}Expense Records{% if month_name %} - {{ month_name }} {{ selected_year }}{% endif %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-end mb-3">
    <a href="{% url 'expense_create' %}" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-circle"></i> Add Expense
    </a>
</div>

<!-- Filter Form -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-2 align-items-end">
            <div class="col-lg-1 col-md-2 col-sm-4">
                <label class="form-label small mb-1">Category</label>
                <select name="category" class="form-select form-select-sm">
                    <option value="">All</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2 col-md-2 col-sm-4">
                <label class="form-label small mb-1">Account</label>
                <select name="account" class="form-select form-select-sm">
                    <option value="">All</option>
                    {% for account in accounts %}
                    <option value="{{ account.id }}" {% if request.GET.account == account.id|stringformat:"s" %}selected{% endif %}>{{ account.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-1 col-md-2 col-sm-4">
                <label class="form-label small mb-1">Month</label>
                <select name="month" class="form-select form-select-sm">
                    <option value="">All</option>
                    <option value="1" {% if selected_month == "1" %}selected{% endif %}>Jan</option>
                    <option value="2" {% if selected_month == "2" %}selected{% endif %}>Feb</option>
                    <option value="3" {% if selected_month == "3" %}selected{% endif %}>Mar</option>
                    <option value="4" {% if selected_month == "4" %}selected{% endif %}>Apr</option>
                    <option value="5" {% if selected_month == "5" %}selected{% endif %}>May</option>
                    <option value="6" {% if selected_month == "6" %}selected{% endif %}>Jun</option>
                    <option value="7" {% if selected_month == "7" %}selected{% endif %}>Jul</option>
                    <option value="8" {% if selected_month == "8" %}selected{% endif %}>Aug</option>
                    <option value="9" {% if selected_month == "9" %}selected{% endif %}>Sep</option>
                    <option value="10" {% if selected_month == "10" %}selected{% endif %}>Oct</option>
                    <option value="11" {% if selected_month == "11" %}selected{% endif %}>Nov</option>
                    <option value="12" {% if selected_month == "12" %}selected{% endif %}>Dec</option>
                </select>
            </div>
            <div class="col-lg-1 col-md-1 col-sm-3">
                <label class="form-label small mb-1">Year</label>
                <input type="number" name="year" class="form-control form-control-sm" value="{{ selected_year }}" min="2020" max="2030">
            </div>
            <div class="col-lg-1 col-md-2 col-sm-5">
                <label class="form-label small mb-1">Min $</label>
                <input type="number" name="min_amount" class="form-control form-control-sm" placeholder="0" step="0.01" value="{{ request.GET.min_amount }}">
            </div>
            <div class="col-lg-1 col-md-2 col-sm-6">
                <label class="form-label small mb-1">Max $</label>
                <input type="number" name="max_amount" class="form-control form-control-sm" placeholder="0" step="0.01" value="{{ request.GET.max_amount }}">
            </div>
            <div class="col-lg-3 col-md-4 col-sm-9">
                <label class="form-label small mb-1">Tags</label>
                <div class="dropdown w-100">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100 text-start d-flex align-items-center" type="button" id="tagDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="padding: 0.25rem 0.5rem;">
                        <span id="tagDisplay" style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.875rem;">
                            {% if selected_tags %}
                                {% for tag in all_tags %}
                                    {% if tag.id in selected_tags %}
                                        <span class="badge tag-badge-selected me-1" style="background-color: {{ tag.color }}; color: white; font-size: 0.65rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">{{ tag.name }}</span>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                All tags
                            {% endif %}
                        </span>
                    </button>
                    <ul class="dropdown-menu w-100" aria-labelledby="tagDropdown" style="max-height: 300px; overflow-y: auto; min-width: 200px; padding: 0.5rem;">
                        {% if all_tags %}
                            {% for tag in all_tags %}
                            <li class="tag-item {% if tag.id in selected_tags %}selected{% endif %}" style="padding: 0.25rem 0.5rem; margin: 0;">
                                <div class="form-check" style="margin: 0; padding-left: 1.5rem;">
                                    <input class="form-check-input tag-checkbox" type="checkbox" name="tag" value="{{ tag.id }}" id="tag-{{ tag.id }}" 
                                           {% if tag.id in selected_tags %}checked{% endif %}
                                           onchange="updateTagDisplay()" style="width: 14px; height: 14px;">
                                    <label class="form-check-label" for="tag-{{ tag.id }}" style="font-size: 0.8rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; cursor: pointer; user-select: none;">
                                        <span class="badge me-1" style="background-color: {{ tag.color }}; color: white; font-size: 0.65rem; padding: 0.25rem 0.5rem;">{{ tag.name }}</span>
                                    </label>
                                </div>
                            </li>
                            {% endfor %}
                            <li><hr class="dropdown-divider" style="margin: 0.5rem 0;"></li>
                            <li style="padding: 0.25rem 0.5rem;">
                                <button type="button" class="btn btn-link btn-sm text-decoration-none p-0" onclick="clearAllTags()" style="font-size: 0.8rem;">
                                    <i class="bi bi-x-circle"></i> Clear All
                                </button>
                            </li>
                        {% else %}
                            <li style="padding: 0.5rem;">
                                <span class="text-muted">No tags available</span>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            <div class="col-lg-2 col-md-3 col-sm-3">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                    <i class="bi bi-filter"></i> Filter
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Total Summary -->
<div class="card mb-4 border-danger">
    <div class="card-body bg-light">
        <h4 class="text-danger mb-0">
            <i class="bi bi-arrow-up-circle"></i> Total Expenses: ${{ total_expense|floatformat:2 }}
        </h4>
    </div>
</div>

<!-- Bulk Actions Bar -->
<div id="bulkActionsBar" class="card mb-3" style="display: none;">
    <div class="card-body py-2">
        <div class="row g-2 align-items-center">
            <div class="col-auto">
                <span id="selectedCount" class="fw-bold">0 selected</span>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-sm btn-primary" onclick="showBulkTagModal('add')">
                    <i class="bi bi-plus-circle"></i> Add Tags
                </button>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-sm btn-warning" onclick="showBulkTagModal('remove')">
                    <i class="bi bi-dash-circle"></i> Remove Tags
                </button>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-sm btn-danger" onclick="showBulkDeleteModal()">
                    <i class="bi bi-trash"></i> Delete Selected
                </button>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-sm btn-secondary" onclick="clearSelection()">
                    <i class="bi bi-x-circle"></i> Clear Selection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Expense List -->
<div class="card">
    <div class="card-body">
        {% if expenses %}
        <form id="bulkForm" method="post" action="{% url 'expense_bulk_tag' %}">
            {% csrf_token %}
            <input type="hidden" name="action" id="bulkAction">
            <input type="hidden" name="tags" id="bulkTags">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Account</th>
                            <th>Tags</th>
                            <th class="text-end">Amount</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in expenses %}
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input expense-checkbox" name="expense_ids" value="{{ expense.pk }}" onchange="updateBulkActions()">
                            </td>
                            <td>{{ expense.date }}</td>
                            <td>{{ expense.description|truncatewords:8 }}</td>
                            <td><span class="badge bg-warning">{{ expense.category.name }}</span></td>
                            <td>{{ expense.bank_account.name|default:"N/A" }}</td>
                            <td>
                                {% for tag in expense.tags.all %}
                                <span class="badge me-1" style="background-color: {{ tag.color }}; color: white; font-size: 0.7rem;">{{ tag.name }}</span>
                                {% empty %}
                                <span class="text-muted small">-</span>
                                {% endfor %}
                            </td>
                            <td class="text-end text-danger fw-bold">${{ expense.amount|floatformat:2 }}</td>
                            <td class="text-center">
                                <a href="{% url 'expense_update' expense.pk %}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'expense_delete' expense.pk %}" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 64px; color: #ccc;"></i>
            <p class="text-muted mt-3">No expense records found</p>
            <a href="{% url 'expense_create' %}" class="btn btn-primary">Add Your First Expense</a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.tag-badge-selected {
    background-color: #0d6efd !important;
    color: white !important;
    font-size: 0.65rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
}

.dropdown-toggle::after {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
}

.tag-item {
    transition: background-color 0.2s;
}

.tag-item.selected {
    background-color: #e7f3ff !important;
}

.tag-item.selected label {
    color: #0d6efd;
    font-weight: 500;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function updateTagDisplay() {
    const checkboxes = document.querySelectorAll('.tag-checkbox');
    const tagDisplay = document.getElementById('tagDisplay');
    const selectedTags = [];
    
    checkboxes.forEach(checkbox => {
        const tagItem = checkbox.closest('.tag-item');
        if (checkbox.checked) {
            const label = checkbox.nextElementSibling;
            const tagBadge = label.querySelector('.badge');
            if (tagBadge) {
                selectedTags.push({
                    text: tagBadge.textContent.trim(),
                    color: tagBadge.style.backgroundColor
                });
            }
            tagItem.classList.add('selected');
        } else {
            tagItem.classList.remove('selected');
        }
    });
    
    if (selectedTags.length > 0) {
        tagDisplay.innerHTML = selectedTags.map(tag => 
            `<span class="badge tag-badge-selected me-1" style="background-color: ${tag.color}; color: white; font-size: 0.65rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${tag.text}</span>`
        ).join('');
    } else {
        tagDisplay.textContent = 'Select tags...';
    }
}

function clearAllTags() {
    const checkboxes = document.querySelectorAll('.tag-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateTagDisplay();
}

// Initialize display on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTagDisplay();
});

// Bulk operations
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.expense-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateBulkActions();
}

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.expense-checkbox:checked');
    const count = checkboxes.length;
    const bulkBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    
    if (count > 0) {
        bulkBar.style.display = 'block';
        selectedCount.textContent = `${count} selected`;
    } else {
        bulkBar.style.display = 'none';
        document.getElementById('selectAll').checked = false;
    }
}

function clearSelection() {
    document.querySelectorAll('.expense-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateBulkActions();
}

function showBulkTagModal(action) {
    document.getElementById('bulkActionType').value = action;
    document.getElementById('modalTitle').textContent = action === 'add' ? 'Add Tags' : 'Remove Tags';
    document.getElementById('modalSubmitBtn').textContent = action === 'add' ? 'Add Tags' : 'Remove Tags';
    document.getElementById('modalSubmitBtn').className = action === 'add' ? 'btn btn-primary' : 'btn btn-warning';
    
    // Clear previous selections
    document.querySelectorAll('.bulk-tag-checkbox').forEach(cb => cb.checked = false);
    
    const modal = new bootstrap.Modal(document.getElementById('bulkTagModal'));
    modal.show();
}

function submitBulkTags() {
    const selectedTags = Array.from(document.querySelectorAll('.bulk-tag-checkbox:checked')).map(cb => cb.value);
    if (selectedTags.length === 0) {
        alert('Please select at least one tag');
        return;
    }
    
    const action = document.getElementById('bulkActionType').value;
    document.getElementById('bulkAction').value = action;
    document.getElementById('bulkTags').value = selectedTags.join(',');
    document.getElementById('bulkForm').submit();
}

function showBulkDeleteModal() {
    const count = document.querySelectorAll('.expense-checkbox:checked').length;
    document.getElementById('deleteCount').textContent = count;
    const modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
    modal.show();
}

function confirmBulkDelete() {
    const form = document.getElementById('bulkForm');
    form.action = '{% url "expense_bulk_delete" %}';
    form.submit();
}
</script>

<!-- Bulk Tag Modal -->
<div class="modal fade" id="bulkTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Tags</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="bulkActionType">
                <p class="text-muted mb-3">Select tags to add/remove from selected transactions:</p>
                {% if all_tags %}
                    <div class="list-group">
                        {% for tag in all_tags %}
                        <label class="list-group-item">
                            <input class="form-check-input me-2 bulk-tag-checkbox" type="checkbox" value="{{ tag.id }}">
                            <span class="badge" style="background-color: {{ tag.color }}; color: white;">{{ tag.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No tags available. <a href="{% url 'tag_create' %}">Create a tag</a> first.</p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="modalSubmitBtn" class="btn btn-primary" onclick="submitBulkTags()">Add Tags</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Bulk Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger mb-3">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
                <p class="mb-0">Are you sure you want to delete <strong id="deleteCount">0</strong> expense transaction(s)?</p>
                <p class="text-muted small mt-2">This will also update the balances of the associated accounts.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmBulkDelete()">
                    <i class="bi bi-trash"></i> Delete All Selected
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

